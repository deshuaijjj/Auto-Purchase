import pyautogui
import time
from datetime import datetime
import logging
import subprocess
import sys


def check_accessibility_permission():
    """æ£€æŸ¥macOSè¾…åŠ©åŠŸèƒ½æƒé™"""
    try:
        pos = pyautogui.position()
        return True
    except Exception:
        return False

def show_permission_help():
    """æ˜¾ç¤ºæƒé™æˆäºˆå¸®åŠ©"""
    print("=" * 60)
    print("âŒ è¾…åŠ©åŠŸèƒ½æƒé™æœªæˆäºˆï¼")
    print("=" * 60)
    print()
    print("pyautogui éœ€è¦è¾…åŠ©åŠŸèƒ½æƒé™æ‰èƒ½æ§åˆ¶é¼ æ ‡å’Œé”®ç›˜")
    print()
    print("ğŸ“‹ æˆäºˆæƒé™æ­¥éª¤ï¼š")
    print("   1. æ‰“å¼€ ç³»ç»Ÿè®¾ç½®ï¼ˆSystem Settingsï¼‰")
    print("   2. ç‚¹å‡» éšç§ä¸å®‰å…¨æ€§ï¼ˆPrivacy & Securityï¼‰")
    print("   3. ç‚¹å‡» è¾…åŠ©åŠŸèƒ½ï¼ˆAccessibilityï¼‰")
    print("   4. ç‚¹å‡»å·¦ä¸‹è§’çš„ ğŸ”’ é”å›¾æ ‡å¹¶è¾“å…¥å¯†ç è§£é”")
    print("   5. æ‰¾åˆ°å¹¶å‹¾é€‰ä»¥ä¸‹åº”ç”¨ä¹‹ä¸€ï¼š")
    print("      - Terminalï¼ˆç»ˆç«¯ï¼‰")
    print("      - Python")
    print("      - æˆ–è¿è¡Œæ­¤è„šæœ¬çš„åº”ç”¨")
    print("   6. å¦‚æœæ‰¾ä¸åˆ°ï¼Œç‚¹å‡» â• æŒ‰é’®æ·»åŠ åº”ç”¨")
    print()
    print("=" * 60)
    print()
    
    choice = input("æ˜¯å¦è‡ªåŠ¨æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¡µé¢ï¼Ÿ(y/n): ").strip().lower()
    if choice in ['y', 'yes']:
        try:
            subprocess.run([
                'open',
                'x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility'
            ])
            print("âœ… å·²æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¡µé¢")
        except Exception as e:
            print(f"âŒ æ— æ³•è‡ªåŠ¨æ‰“å¼€è®¾ç½®: {e}")
            print("   è¯·æ‰‹åŠ¨æ‰“å¼€ç³»ç»Ÿè®¾ç½®")
    
    print()
    print("ğŸ’¡ é‡è¦ï¼šæˆäºˆæƒé™åï¼Œéœ€è¦å®Œå…¨é€€å‡ºå¹¶é‡æ–°è¿è¡Œç¨‹åºæ‰èƒ½ç”Ÿæ•ˆ")
    print()


def wait_until_time(target_time: datetime):
    """ç­‰å¾…åˆ°æŒ‡å®šæ—¶é—´"""
    now = datetime.now()
    time_diff_initial = (target_time - now).total_seconds()
    
    print("=" * 60)
    print("â° ç­‰å¾…å¼€å§‹æ—¶é—´...")
    print(f"   ç›®æ ‡æ—¶é—´: {target_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"   å½“å‰æ—¶é—´: {now.strftime('%Y-%m-%d %H:%M:%S')}")
    
    if time_diff_initial < 0:
        print(f"   âš ï¸ å¼€å§‹æ—¶é—´å·²è¿‡ï¼å·²è¿‡å» {abs(time_diff_initial):.2f}ç§’")
        print("   ç¨‹åºå°†ç«‹å³æ‰§è¡Œ")
        print("=" * 60)
        print()
        return
    else:
        print(f"   è·ç¦»å¼€å§‹: {time_diff_initial:.2f}ç§’")
        print(f"   å°†åœ¨å¼€å§‹å‰10ç§’æ˜¾ç¤ºå€’è®¡æ—¶")
        print("=" * 60)
        print()
    
    last_countdown_second = -1  # è®°å½•ä¸Šæ¬¡æ˜¾ç¤ºçš„å€’è®¡æ—¶ç§’æ•°
    last_info_second = -1  # è®°å½•ä¸Šæ¬¡æ˜¾ç¤ºä¿¡æ¯çš„ç§’æ•°
    
    while True:
        now = datetime.now()
        time_diff = (target_time - now).total_seconds()
        
        if time_diff <= 0:
            print("=" * 60)
            print("ğŸš€ å¼€å§‹æ—¶é—´åˆ°ï¼")
            print("=" * 60)
            print()
            break
        
        # å¼€ç¥¨å‰10ç§’å¼€å§‹å€’è®¡æ—¶ï¼ˆæ¯ç§’æ˜¾ç¤ºä¸€æ¬¡ï¼‰
        if time_diff <= 10 and time_diff > 0:
            current_second = int(time_diff)
            if current_second != last_countdown_second:
                print(f"â³ å€’è®¡æ—¶: {current_second}ç§’")
                last_countdown_second = current_second
        
        # å¦‚æœè·ç¦»å¼€ç¥¨æ—¶é—´è¶…è¿‡10ç§’ï¼Œæ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        elif time_diff > 10:
            current_second = int(time_diff)
            # æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦ï¼ˆä¾‹å¦‚ï¼š60ç§’ã€50ç§’ã€40ç§’...ï¼‰
            if current_second % 10 == 0 and current_second != last_info_second:
                if time_diff >= 60:
                    minutes = int(time_diff // 60)
                    seconds = int(time_diff % 60)
                    print(f"â³ è·ç¦»å¼€å§‹: {minutes}åˆ†{seconds}ç§’")
                else:
                    print(f"â³ è·ç¦»å¼€å§‹: {current_second}ç§’")
                last_info_second = current_second
            # å¦‚æœåˆšè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆç¬¬ä¸€æ¬¡å¾ªç¯ï¼‰ï¼Œç«‹å³æ˜¾ç¤ºä¸€æ¬¡
            elif last_info_second == -1:
                if time_diff >= 60:
                    minutes = int(time_diff // 60)
                    seconds = int(time_diff % 60)
                    print(f"â³ è·ç¦»å¼€å§‹: {minutes}åˆ†{seconds}ç§’")
                else:
                    print(f"â³ è·ç¦»å¼€å§‹: {current_second}ç§’")
                last_info_second = current_second
        
        # æå‰å‡†å¤‡ï¼ˆæå‰100mså¼€å§‹å‡†å¤‡ï¼Œç¡®ä¿ç²¾ç¡®ï¼‰
        if time_diff <= 0.1:
            # ç²¾ç¡®ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´ï¼ˆä½¿ç”¨å¾®ç§’çº§ç²¾åº¦ï¼‰
            while True:
                now = datetime.now()
                time_diff = (target_time - now).total_seconds()
                if time_diff <= 0:
                    break
                # æœ€åé˜¶æ®µä½¿ç”¨æçŸ­çš„sleepï¼Œç¡®ä¿ç²¾ç¡®åˆ°æ¯«ç§’çº§
                if time_diff > 0.01:
                    time.sleep(0.01)
                else:
                    time.sleep(max(0, time_diff * 0.5))  # ä½¿ç”¨ä¸€åŠæ—¶é—´ï¼Œæ›´ç²¾ç¡®
            break
        
        # è‡ªé€‚åº”sleepæ—¶é—´
        if time_diff > 60:
            time.sleep(1)
        elif time_diff > 10:
            time.sleep(0.1)
        else:
            time.sleep(0.01)


def continuous_click(x: int, y: int, duration: float = 5.0):
    """
    è¿ç»­ç‚¹å‡»æŒ‡å®šåæ ‡
    :param x: Xåæ ‡
    :param y: Yåæ ‡
    :param duration: æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
    """
    print("=" * 60)
    print(f"ğŸ”„ å¼€å§‹è¿ç»­ç‚¹å‡»åæ ‡ ({x}, {y})ï¼ŒæŒç»­ {duration} ç§’...")
    print("=" * 60)
    print()
    
    # è®°å½•ç²¾ç¡®çš„å¼€å§‹æ—¶é—´
    start_time = time.time()
    start_datetime = datetime.now()
    
    print(f"   å¼€å§‹æ—¶é—´: {start_datetime.strftime('%H:%M:%S.%f')[:-3]}")
    print()
    
    click_count = 0
    
    # ç²¾ç¡®æ§åˆ¶æŒç»­æ—¶é—´
    while (time.time() - start_time) < duration:
        try:
            pyautogui.moveTo(x, y, duration=0)
            pyautogui.click(x, y, duration=0)
            click_count += 1
            time.sleep(0.01)  # 10msé—´éš”
        except Exception as e:
            print(f"âš ï¸ ç‚¹å‡»å¤±è´¥: {e}")
    
    end_time = time.time()
    elapsed = end_time - start_time
    end_datetime = datetime.now()
    
    print()
    print("=" * 60)
    print("âœ… è¿ç»­ç‚¹å‡»å®Œæˆ")
    print(f"   å¼€å§‹æ—¶é—´: {start_datetime.strftime('%H:%M:%S.%f')[:-3]}")
    print(f"   ç»“æŸæ—¶é—´: {end_datetime.strftime('%H:%M:%S.%f')[:-3]}")
    print(f"   æŒç»­æ—¶é—´: {elapsed:.3f}ç§’")
    print(f"   ç‚¹å‡»æ¬¡æ•°: {click_count}æ¬¡")
    print(f"   å¹³å‡é€Ÿåº¦: {click_count/elapsed:.1f}æ¬¡/ç§’")
    print("=" * 60)


def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ“ ä¹’ä¹“çƒè¿ç‚¹è„šæœ¬")
    print("=" * 60)
    print()
    
    # æ£€æŸ¥æƒé™
    if not check_accessibility_permission():
        show_permission_help()
        sys.exit(1)
    
    # é…ç½®pyautogui
    pyautogui.FAILSAFE = True  # é¼ æ ‡ç§»åˆ°è§’è½å¯ç´§æ€¥åœæ­¢
    pyautogui.PAUSE = 0  # æ— å»¶è¿Ÿ
    
    # è®¾ç½®ç›®æ ‡æ—¶é—´å’Œåæ ‡
    target_time = datetime(2025, 11, 20, 12, 31, 0, 0)
    click_x, click_y = 253, 770
    click_duration = 3.0  # æŒç»­5ç§’
    
    print(f"ğŸ“ ç‚¹å‡»åæ ‡: ({click_x}, {click_y})")
    print(f"â° å¼€å§‹æ—¶é—´: {target_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"â±ï¸  æŒç»­æ—¶é—´: {click_duration}ç§’")
    print()
    
    # ç­‰å¾…åˆ°æŒ‡å®šæ—¶é—´
    wait_until_time(target_time)
    
    # å¼€å§‹è¿ç»­ç‚¹å‡»
    continuous_click(click_x, click_y, click_duration)
    
    print()
    print("ğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæˆï¼")


if __name__ == "__main__":
    main()

